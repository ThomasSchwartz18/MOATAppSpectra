{% extends 'base.html' %}

{% block content %}
<section class="page-intro">
  <div>
    <h1>Administration Console</h1>
    <p>Configure Spectra Operations Suite for your organization, manage access, and oversee system integrations.</p>
  </div>
  <div class="intro-meta">
    <span class="meta-label">Supabase Project</span>
    <span class="meta-value">{{ supabase_status.project_host or 'Not configured' }}</span>
  </div>
</section>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  <ul class="flash-messages">
    {% for category, message in messages %}
    <li>{{ message }}</li>
    {% endfor %}
  </ul>
  {% endif %}
{% endwith %}

<section class="admin-console" data-tabs>
  <aside class="tab-nav" role="tablist" aria-label="Administration Sections">
    <button class="tab-link is-active" type="button" role="tab" aria-selected="true" tabindex="0" data-tab-target="overview">Overview</button>
    <button class="tab-link" type="button" role="tab" aria-selected="false" tabindex="-1" data-tab-target="data">Data Connections</button>
    <button class="tab-link" type="button" role="tab" aria-selected="false" tabindex="-1" data-tab-target="users">User Accounts</button>
    <button class="tab-link" type="button" role="tab" aria-selected="false" tabindex="-1" data-tab-target="roles">Roles &amp; Permissions</button>
    <button class="tab-link" type="button" role="tab" aria-selected="false" tabindex="-1" data-tab-target="system">System Policies</button>
  </aside>

  <div class="tab-panels">
    <article class="tab-panel is-active" role="tabpanel" data-tab-panel="overview" aria-hidden="false">
      <h2>Operational Snapshot</h2>
      {% set available_tables = overview.tracked_tables | selectattr('status', 'equalto', 'Available') | list %}
      {% set unavailable_tables = overview.tracked_tables | selectattr('status', 'equalto', 'Unavailable') | list %}
      <div class="grid-two">
        <div class="summary-block">
          <h3>Platform Status</h3>
          <ul>
            <li><strong>Supabase Connection</strong> &mdash; {{ overview.supabase_status }}</li>
            <li><strong>Tracked Tables Available</strong> &mdash; {{ available_tables|length }} / {{ overview.tracked_tables|length }}</li>
            <li><strong>Users with Console Access</strong> &mdash; {{ overview.user_count }}</li>
            <li><strong>Last Connectivity Check</strong> &mdash; {{ overview.last_checked.strftime('%Y-%m-%d %H:%M UTC') }}</li>
          </ul>
        </div>
        <div class="summary-block">
          <h3>Quick Actions</h3>
          <div class="action-grid">
            <form method="post" action="{{ url_for('main.admin_data_sources_action') }}">
              <input type="hidden" name="action" value="create">
              <button type="submit" class="primary">Add Database Source</button>
            </form>
            <form method="post" action="{{ url_for('main.admin_user_action') }}">
              <input type="hidden" name="action" value="invite">
              <button type="submit" class="primary">Invite User</button>
            </form>
            <a class="ghost" href="https://app.supabase.com/project" target="_blank" rel="noopener">Open Supabase Console</a>
            <a class="ghost" href="https://supabase.com/docs" target="_blank" rel="noopener">Supabase Docs</a>
          </div>
        </div>
      </div>
      <div class="summary-block">
        <h3>Tracked Tables</h3>
        <table class="data-table">
          <thead>
            <tr>
              <th>Table</th>
              <th>Description</th>
              <th>Status</th>
              <th>Records Previewed</th>
            </tr>
          </thead>
          <tbody>
            {% for table in overview.tracked_tables %}
            <tr>
              <td>{{ table.name }}</td>
              <td>{{ table.description }}</td>
              <td>
                {% if table.status == 'Available' %}
                  <span class="status status-online">{{ table.status }}</span>
                {% else %}
                  <span class="status status-offline">{{ table.status }}</span>
                {% endif %}
                {% if table.error %}
                  <br><small>{{ table.error }}</small>
                {% endif %}
              </td>
              <td>{% if table.records_previewed is not none %}{{ table.records_previewed }}{% else %}&mdash;{% endif %}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% if supabase_status.error %}
      <div class="summary-block">
        <h3>Connection Diagnostics</h3>
        <p>Attempted to reach Supabase but received: <code>{{ supabase_status.error }}</code>.</p>
      </div>
      {% endif %}
      {% if unavailable_tables %}
      <div class="summary-block">
        <h3>Untracked Data</h3>
        <p>The following tables could not be queried. Confirm that they exist and that the service role key has access.</p>
        <ul>
          {% for table in unavailable_tables %}
          <li><strong>{{ table.name }}</strong> &mdash; {{ table.description }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </article>

    <article class="tab-panel" role="tabpanel" data-tab-panel="data" aria-hidden="true">
      <h2>Data Connections</h2>
      <p>Link production databases and control how data synchronizes with Spectra Operations Suite.</p>
      <div class="summary-block">
        <h3>Supabase Project</h3>
        <table class="data-table">
          <tbody>
            <tr>
              <th scope="row">Project URL</th>
              <td>{% if supabase_status.url %}<code>{{ supabase_status.url }}</code>{% else %}Not configured{% endif %}</td>
            </tr>
            <tr>
              <th scope="row">Status</th>
              <td>{{ supabase_status.status }}</td>
            </tr>
            <tr>
              <th scope="row">Last Checked</th>
              <td>{{ supabase_status.checked_at.strftime('%Y-%m-%d %H:%M UTC') }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="summary-block">
        <h3>Tracked Tables</h3>
        <table class="data-table">
          <thead>
            <tr>
              <th>Table</th>
              <th>Status</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
            {% for table in supabase_status.tables %}
            <tr>
              <td>{{ table.name }}</td>
              <td>{{ table.status }}</td>
              <td>
                {{ table.description }}
                {% if table.error %}
                  <br><small>{{ table.error }}</small>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <form class="config-form" method="post" action="{{ url_for('main.admin_data_sources_action') }}">
        <h3>Request Data Source Change</h3>
        <div class="form-grid">
          <label>
            Data Source Name
            <input type="text" name="data_source_name" placeholder="e.g., AOI Production Cluster">
          </label>
          <label>
            Connection Type
            <select name="connection_type">
              <option value="postgres">PostgreSQL</option>
              <option value="mssql">SQL Server</option>
              <option value="mysql">MySQL</option>
              <option value="oracle">Oracle</option>
              <option value="api">REST API</option>
            </select>
          </label>
          <label>
            Host
            <input type="text" name="host" placeholder="db01.corp.local">
          </label>
          <label>
            Port
            <input type="number" name="port" value="5432">
          </label>
          <label>
            Database Name
            <input type="text" name="database_name" placeholder="operations_core">
          </label>
          <label>
            Sync Interval (minutes)
            <input type="number" name="sync_interval" value="15">
          </label>
        </div>
        <div class="form-grid">
          <label>
            Service Account
            <input type="text" name="service_account" placeholder="svc_moa_ops">
          </label>
          <label>
            Encryption
            <select name="encryption">
              <option value="tls12">TLS 1.2</option>
              <option value="tls13">TLS 1.3</option>
              <option value="none">None</option>
            </select>
          </label>
          <label class="full-width">
            Connection Notes
            <textarea name="connection_notes" rows="3" placeholder="Document maintenance windows, failover steps, or escalation contacts."></textarea>
          </label>
        </div>
        <div class="form-actions">
          <input type="hidden" name="action" value="create">
          <button type="submit" class="primary">Submit Request</button>
          <button type="reset" class="ghost">Clear</button>
        </div>
        <p class="form-helper">Automated provisioning is not yet available. Requests are recorded for follow-up in Supabase (recommended table: <code>data_sources</code>).</p>
      </form>
    </article>

    <article class="tab-panel" role="tabpanel" data-tab-panel="users" aria-hidden="true">
      <h2>User Accounts</h2>
      <p>Create and deactivate user accounts to control who can access Spectra Operations Suite.</p>

      <div class="summary-block">
        <h3>Configured Accounts</h3>
        <table class="data-table">
          <thead>
            <tr>
              <th>Username</th>
              <th>Display Name</th>
              <th>Role</th>
              <th>Source</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
            <tr>
              <td>{{ user.username }}</td>
              <td>{{ user.display_name or user.username }}</td>
              <td>{{ user.role }}</td>
              <td>{{ user.source }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <form class="config-form" method="post" action="{{ url_for('main.admin_user_action') }}">
        <h3>Create Account</h3>
        <div class="form-grid">
          <label>
            Username
            <input type="text" name="username" placeholder="New user name">
          </label>
          <label>
            Display Name
            <input type="text" name="display_name" placeholder="Shown in navigation" autocomplete="name">
          </label>
          <label>
            Role
            <select name="role">
              {% for code, label in user_role_choices %}
              <option value="{{ code }}">{{ label }}</option>
              {% endfor %}
            </select>
          </label>
          <label>
            Temporary Password
            <input type="text" name="temporary_password" placeholder="Provide or auto-generate">
          </label>
        </div>
        <div class="form-actions">
          <input type="hidden" name="action" value="invite">
          <button type="submit" class="primary">Create User</button>
          <button type="button" class="ghost" onclick="this.closest('form').reset()">Clear</button>
        </div>
        <p class="form-helper">Accounts created here are stored in the Supabase table <code>app_users</code>. New users must change their temporary password the first time they sign in.</p>
      </form>

      <form class="config-form" method="post" action="{{ url_for('main.admin_user_action') }}">
        <h3>Remove Account</h3>
        <div class="form-grid">
          <label>
            Username
            <input type="text" name="username" placeholder="Existing user name">
          </label>
        </div>
        <div class="form-actions">
          <input type="hidden" name="action" value="remove">
          <button type="submit" class="ghost">Remove User</button>
        </div>
        <p class="form-helper">Only Supabase-managed accounts can be removed here. Environment-backed users such as <code>ADMIN</code> remain available for emergency access.</p>
      </form>
    </article>

    <article class="tab-panel" role="tabpanel" data-tab-panel="roles" aria-hidden="true">
      <h2>Roles &amp; Permissions</h2>
      <div class="summary-block">
        <p>{{ missing_feeds.roles }}</p>
        <p class="form-helper">Until a dedicated data feed is implemented, update role descriptions directly in the codebase or maintain a Supabase table named <code>roles</code> with modules, capabilities, and allowed actions.</p>
      </div>
    </article>

    <article class="tab-panel" role="tabpanel" data-tab-panel="system" aria-hidden="true">
      <h2>System Policies</h2>
      <div class="summary-block">
        <p>{{ missing_feeds.system_policies }}</p>
        <p class="form-helper">Policy values (session timeout, MFA, retention) are currently set via deployment configuration. Capture them in Supabase storage or a configuration management service to edit them here.</p>
      </div>
    </article>
  </div>
</section>
{% endblock %}
