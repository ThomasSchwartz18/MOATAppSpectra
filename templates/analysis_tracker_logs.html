{% extends 'base.html' %}

{% block extra_head %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-datatables@9.0.0/dist/style.css">
  <style>
    .tracker-dashboard {
      padding: 1.5rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    .tracker-dashboard h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .tracker-dashboard p.page-intro {
      margin-bottom: 1.5rem;
      color: #333;
    }

    .dashboard-tabs {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .dashboard-tabs .tab-nav {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      border-bottom: 1px solid #dbe2ef;
      padding-bottom: 0.5rem;
    }

    .dashboard-tabs .tab-link {
      border: 1px solid transparent;
      background: #f1f5f9;
      padding: 0.6rem 1rem;
      border-radius: 999px;
      font-size: 0.85rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #475569;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .dashboard-tabs .tab-link:hover,
    .dashboard-tabs .tab-link:focus {
      background: #e2e8f0;
      color: #1d4ed8;
      outline: none;
    }

    .dashboard-tabs .tab-link.is-active {
      background: #1d4ed8;
      color: #fff;
      border-color: #1d4ed8;
    }

    .dashboard-tabs .tab-panels {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .dashboard-tabs .tab-panel {
      display: none;
      flex-direction: column;
      gap: 1.5rem;
    }

    .dashboard-tabs .tab-panel.is-active {
      display: flex;
    }

    .tracker-dashboard .filters {
      display: grid;
      gap: 0.75rem 1rem;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      margin-bottom: 1.5rem;
      background: #f7f9fc;
      border: 1px solid #dbe2ef;
      border-radius: 8px;
      padding: 1rem;
    }

    .tracker-dashboard .filters label {
      display: flex;
      flex-direction: column;
      font-size: 0.85rem;
      color: #4a4a4a;
    }

    .tracker-dashboard .filters input,
    .tracker-dashboard .filters select {
      margin-top: 0.25rem;
      padding: 0.4rem 0.5rem;
      border-radius: 4px;
      border: 1px solid #cbd5e1;
      font-size: 0.9rem;
    }

    .tracker-dashboard .filters button {
      align-self: end;
      padding: 0.55rem 0.9rem;
      background: #1d4ed8;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }

    .tracker-dashboard .filters button.secondary {
      background: #64748b;
      margin-left: 0.5rem;
    }

    .tracker-dashboard .stats-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }

    .tracker-dashboard .stat-card {
      background: #fff;
      border: 1px solid #dbe2ef;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
    }

    .tracker-dashboard .stat-card h3 {
      margin: 0;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #475569;
    }

    .tracker-dashboard .stat-card strong {
      display: block;
      margin-top: 0.35rem;
      font-size: 1.4rem;
      color: #0f172a;
    }

    .tracker-dashboard .charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
    }

    .tracker-dashboard .chart-card {
      background: #fff;
      border-radius: 8px;
      border: 1px solid #dbe2ef;
      padding: 1rem;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
      position: relative;
    }

    .tracker-dashboard .chart-card canvas {
      width: 100% !important;
      height: 260px !important;
    }

    .tracker-dashboard .chart-card h2 {
      font-size: 1rem;
      margin-bottom: 0.75rem;
      color: #1f2937;
    }

    .tracker-dashboard table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1.5rem;
      background: #fff;
    }

    .tracker-dashboard table thead {
      background: #0f172a;
      color: #fff;
    }

    .tracker-dashboard table th,
    .tracker-dashboard table td {
      padding: 0.65rem;
      border: 1px solid #e2e8f0;
      vertical-align: top;
      font-size: 0.9rem;
    }

    .tracker-dashboard table tbody tr:nth-child(even) {
      background: #f8fafc;
    }

    .tracker-dashboard table tbody tr.has-backtracking {
      background: #fff4f4;
    }

    .tracker-dashboard .path {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
    }

    .tracker-dashboard .path span {
      background: #e2e8f0;
      padding: 0.2rem 0.45rem;
      border-radius: 999px;
      font-size: 0.75rem;
    }

    .tracker-dashboard .path span.is-backtrack {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fca5a5;
    }

    .tracker-dashboard details summary {
      cursor: pointer;
      color: #1d4ed8;
    }

    .tracker-dashboard .backtracking-highlights {
      margin-top: 2rem;
    }

    .tracker-dashboard .backtracking-highlights ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 0.75rem;
    }

    .tracker-dashboard .backtracking-highlights li {
      border: 1px solid #fca5a5;
      background: #fff1f2;
      border-radius: 8px;
      padding: 0.75rem;
    }

    .tracker-dashboard .backtracking-highlights h3 {
      margin: 0 0 0.35rem;
      font-size: 1rem;
      color: #b91c1c;
    }

    .tracker-dashboard .table-section h2 {
      font-size: 1.2rem;
      margin: 1rem 0 0.5rem;
      color: #1f2937;
    }

    .bug-status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
    }

    .bug-status-card {
      background: #fff;
      border: 1px solid #dbe2ef;
      border-radius: 8px;
      padding: 0.75rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
    }

    .bug-status-card .status-label {
      font-size: 0.9rem;
      color: #475569;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .bug-status-card strong {
      font-size: 1.6rem;
      color: #0f172a;
    }

    .bug-summary p {
      margin-top: 0.25rem;
    }

    .bug-summary details {
      margin-top: 0.5rem;
    }

    .bug-filter-form {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: flex-end;
      margin-bottom: 1rem;
    }

    .bug-filter-form label {
      display: flex;
      flex-direction: column;
      font-size: 0.85rem;
      color: #4a4a4a;
    }

    .bug-filter-form select,
    .bug-filter-form input {
      margin-top: 0.25rem;
      padding: 0.4rem 0.5rem;
      border-radius: 4px;
      border: 1px solid #cbd5e1;
      font-size: 0.9rem;
    }

    .bug-filter-form button {
      padding: 0.55rem 0.9rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    .bug-filter-form button[type="submit"] {
      background: #1d4ed8;
      color: #fff;
    }

    .bug-filter-form button[type="reset"] {
      background: #e2e8f0;
      color: #1f2937;
    }

    .bug-action-form {
      display: grid;
      gap: 0.5rem;
    }

    .bug-action-form label {
      display: flex;
      flex-direction: column;
      font-size: 0.8rem;
      color: #475569;
    }

    .bug-action-form select,
    .bug-action-form textarea {
      margin-top: 0.2rem;
      border-radius: 4px;
      border: 1px solid #cbd5e1;
      padding: 0.4rem;
      font-size: 0.85rem;
    }

    .bug-action-form textarea {
      resize: vertical;
      min-height: 60px;
    }

    .bug-action-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .bug-action-buttons button {
      padding: 0.45rem 0.75rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    .bug-action-buttons button[type="submit"] {
      background: #0f766e;
      color: #fff;
    }

    .bug-action-buttons button[data-action="reset"] {
      background: #e2e8f0;
      color: #0f172a;
    }

    .bug-action-feedback {
      font-size: 0.75rem;
      color: #475569;
      min-height: 1rem;
    }

    .bug-alert {
      border: 1px solid #fbbf24;
      background: #fef3c7;
      color: #92400e;
      padding: 0.75rem 1rem;
      border-radius: 6px;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .status-open {
      background: #eef2ff;
      color: #3730a3;
    }

    .status-in_progress {
      background: #fef3c7;
      color: #b45309;
    }

    .status-resolved {
      background: #dcfce7;
      color: #047857;
    }

    .status-on_hold {
      background: #fef9c3;
      color: #92400e;
    }

    .bug-recent-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 0.5rem;
    }

    .bug-recent-list li {
      background: #fff;
      border: 1px solid #dbe2ef;
      border-radius: 6px;
      padding: 0.65rem 0.75rem;
      font-size: 0.85rem;
    }

    .bug-recent-list strong {
      color: #0f172a;
    }

    .bug-token {
      display: none;
    }

    @media (max-width: 768px) {
      .tracker-dashboard {
        padding: 1rem;
      }

      .tracker-dashboard table,
      .tracker-dashboard table th,
      .tracker-dashboard table td {
        font-size: 0.8rem;
      }

      .bug-action-form {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      }
    }
  </style>
{% endblock %}

{% block content %}
  <div class="tracker-dashboard">
    <h1>Application Tracker Logs</h1>
    <p class="page-intro">Review recent application interaction sessions recorded by the in-app tracker. Use the filters to explore behaviour by role, event type, or backtracking activity.</p>

    <div class="dashboard-tabs" data-tabs>
      <div class="tab-nav" role="tablist" aria-label="Tracker views">
        <button class="tab-link is-active" type="button" role="tab" aria-selected="true" tabindex="0" data-tab-target="analytics">Tracker Analytics</button>
        <button class="tab-link" type="button" role="tab" aria-selected="false" tabindex="-1" data-tab-target="bug-reports">Bug Reports</button>
      </div>

      <div class="tab-panels">
        <section class="tab-panel is-active" role="tabpanel" data-tab-panel="analytics" aria-hidden="false">
          <form class="filters" method="get">
            <label>
              Role
              <select name="role">
                <option value="">All roles</option>
                {% for option in role_options %}
                <option value="{{ option }}" {% if filters.role == option %}selected{% endif %}>{{ option }}</option>
                {% endfor %}
              </select>
            </label>
            <label>
              Event Type
              <select name="event">
                <option value="">All events</option>
                {% for option in event_options %}
                <option value="{{ option }}" {% if filters.event == option %}selected{% endif %}>{{ option }}</option>
                {% endfor %}
              </select>
            </label>
            <label>
              Session / User Search
              <input type="text" name="session" value="{{ filters.session }}" placeholder="Token, username or ID">
            </label>
            <label>
              Backtracking
              <select name="backtracking">
                <option value="any" {% if filters.backtracking == 'any' %}selected{% endif %}>Any activity</option>
                <option value="only" {% if filters.backtracking == 'only' %}selected{% endif %}>Backtracking only</option>
                <option value="exclude" {% if filters.backtracking in ['exclude', 'none'] %}selected{% endif %}>Exclude backtracking</option>
              </select>
            </label>
            <label>
              Start (ISO date)
              <input type="text" name="start" value="{{ filters.start }}" placeholder="YYYY-MM-DD or ISO timestamp">
            </label>
            <label>
              End (ISO date)
              <input type="text" name="end" value="{{ filters.end }}" placeholder="YYYY-MM-DD or ISO timestamp">
            </label>
            <label>
              Session limit
              <input type="number" min="10" max="250" step="10" name="limit" value="{{ filters.limit }}">
            </label>
            <div style="display: flex; justify-content: space-between;">
              <button type="submit">Apply filters</button>
              <button type="submit" name="reset" value="1" class="secondary" formnovalidate>Reset</button>
            </div>
          </form>

          <div class="stats-grid">
            <div class="stat-card">
              <h3>Sessions</h3>
              <strong>{{ stats.total_sessions }}</strong>
            </div>
            <div class="stat-card">
              <h3>Total Events</h3>
              <strong>{{ stats.total_events }}</strong>
            </div>
            <div class="stat-card">
              <h3>Navigation Events</h3>
              <strong>{{ stats.total_navigation }}</strong>
            </div>
            <div class="stat-card">
              <h3>Backtracking Events</h3>
              <strong>{{ stats.total_backtracking }}</strong>
            </div>
            <div class="stat-card">
              <h3>Average Session Duration</h3>
              <strong>{{ stats.avg_duration }}</strong>
            </div>
          </div>

          <section class="charts">
            <div class="chart-card">
              <h2>Session Duration vs Backtracking</h2>
              <canvas id="sessionDurationChart" aria-label="Session duration vs backtracking chart"></canvas>
            </div>
            <div class="chart-card">
              <h2>Event Distribution</h2>
              <canvas id="eventDistributionChart" aria-label="Event distribution chart"></canvas>
            </div>
            <div class="chart-card">
              <h2>Sessions by Role</h2>
              <canvas id="roleBreakdownChart" aria-label="Session count by role"></canvas>
            </div>
          </section>

          <section class="table-section">
            <h2>Recent Sessions</h2>
            {% if sessions %}
            <table id="sessionTable">
              <thead>
                <tr>
                  <th>Session</th>
                  <th>User</th>
                  <th>Role</th>
                  <th>Started</th>
                  <th>Ended</th>
                  <th>Duration</th>
                  <th>Events</th>
                  <th>Navigation</th>
                  <th>Backtracking</th>
                  <th>Navigation Path</th>
                </tr>
              </thead>
              <tbody>
                {% for session in sessions %}
                <tr class="{% if session.has_backtracking %}has-backtracking{% endif %}">
                  <td data-label="Session">{{ session.token }}</td>
                  <td data-label="User">{{ session.username or session.user_id or '—' }}</td>
                  <td data-label="Role">{{ session.role or '—' }}</td>
                  <td data-label="Started">{{ session.start_display or '—' }}</td>
                  <td data-label="Ended">{{ session.end_display or '—' }}</td>
                  <td data-label="Duration">{{ session.duration_label }}</td>
                  <td data-label="Events">{{ session.event_count }}</td>
                  <td data-label="Navigation">{{ session.navigation_count }}</td>
                  <td data-label="Backtracking">{{ session.backtracking_count }}</td>
                  <td data-label="Navigation Path">
                    <div class="path">
                      {% for entry in session.path %}
                      <span class="{% if entry.is_backtrack %}is-backtrack{% endif %}">
                        {{ entry.label or entry.href or 'Navigate' }}
                      </span>
                      {% endfor %}
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% else %}
            <p>No sessions matched the selected filters.</p>
            {% endif %}
          </section>

          <section class="table-section">
            <h2>Interaction Events{% if filters.event %} &ndash; {{ filters.event }}{% endif %}</h2>
            {% if events %}
            <table id="eventTable">
              <thead>
                <tr>
                  <th>Occurred</th>
                  <th>Session</th>
                  <th>User</th>
                  <th>Event</th>
                  <th>Label</th>
                  <th>Context</th>
                </tr>
              </thead>
              <tbody>
                {% for event in events %}
                <tr>
                  <td data-label="Occurred">{{ event.occurred or '—' }}</td>
                  <td data-label="Session">{{ event.session_token or '—' }}</td>
                  <td data-label="User">{{ event.username or event.user_id or '—' }}</td>
                  <td data-label="Event">{{ event.event }}</td>
                  <td data-label="Label">{{ event.label or '—' }}</td>
                  <td data-label="Context">
                    {% if event.metadata %}
                    <details>
                      <summary>View</summary>
                      <pre>{{ event.metadata | tojson(indent=2) }}</pre>
                    </details>
                    {% else %}
                    —
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% else %}
            <p>No interaction events matched the selected filters.</p>
            {% endif %}
          </section>

          {% if backtracking_sessions %}
          <section class="backtracking-highlights">
            <h2>Highlighted Backtracking Activity</h2>
            <ul>
              {% for session in backtracking_sessions %}
              <li>
                <h3>{{ session.username or session.user_id or session.token }}</h3>
                <p><strong>Session:</strong> {{ session.token }}</p>
                <p><strong>Backtracking events:</strong> {{ session.backtracking_count }}</p>
                <p><strong>Duration:</strong> {{ session.duration_label }}</p>
                <ul>
                  {% for entry in session.backtracking_events %}
                  <li>{{ entry.occurred }} &mdash; {{ entry.label or entry.href or 'Navigate' }}</li>
                  {% endfor %}
                </ul>
              </li>
              {% endfor %}
            </ul>
          </section>
          {% endif %}
        </section>

        <section class="tab-panel" role="tabpanel" data-tab-panel="bug-reports" aria-hidden="true">
          <header>
            <h2>Bug Reports</h2>
            <p>Monitor issues submitted by users and coordinate follow-up directly from this dashboard.</p>
          </header>

          {% if bug_reports_error %}
          <div class="bug-alert" role="alert">Unable to load bug reports: {{ bug_reports_error }}</div>
          {% endif %}

          {% if bug_assignee_error %}
          <div class="bug-alert" role="alert">Assignee information could not be fully loaded: {{ bug_assignee_error }}</div>
          {% endif %}

          <div class="bug-status-grid">
            <div class="bug-status-card">
              <span class="status-label">Total Reports</span>
              <strong>{{ bug_total }}</strong>
            </div>
            {% for entry in bug_status_counts %}
            <div class="bug-status-card">
              <span class="status-label">{{ entry.label }}</span>
              <strong>{{ entry.count }}</strong>
            </div>
            {% endfor %}
          </div>

          {% if recent_bug_reports %}
          <section>
            <h3>Recent submissions</h3>
            <ul class="bug-recent-list">
              {% for report in recent_bug_reports %}
              <li>
                <strong>#{{ report.id }}</strong> &mdash; {{ report.title or 'Untitled' }}
                <br>
                <span>Status: {{ report.status_label }} &middot; Submitted {{ report.created_display }}</span>
              </li>
              {% endfor %}
            </ul>
          </section>
          {% endif %}

          <section>
            <h3>All bug reports</h3>
            <form class="bug-filter-form" data-bug-filters>
              <label>
                Status
                <select name="bug_status">
                  <option value="">All statuses</option>
                  {% for option in bug_status_options %}
                  <option value="{{ option.value }}">{{ option.label }}</option>
                  {% endfor %}
                </select>
              </label>
              <label>
                Assignee
                <select name="bug_assignee">
                  <option value="">All owners</option>
                  <option value="unassigned">Unassigned</option>
                  {% for user in bug_assignees %}
                  <option value="{{ user.id }}">{{ user.label }}</option>
                  {% endfor %}
                </select>
              </label>
              <label>
                Search
                <input type="text" name="bug_search" placeholder="Search title, notes, reporter">
              </label>
              <button type="submit">Apply</button>
              <button type="reset">Reset</button>
            </form>

            {% if bug_reports %}
            <table id="bugReportsTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Summary</th>
                  <th>Status</th>
                  <th>Priority</th>
                  <th>Assignee</th>
                  <th>Reporter</th>
                  <th>Created</th>
                  <th>Updated</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for report in bug_reports %}
                <tr data-status="{{ report.status }}" data-assignee="{{ report.assignee_token }}" data-priority="{{ report.priority | lower }}">
                  <td data-label="ID">#{{ report.id }}</td>
                  <td data-label="Summary">
                    <div class="bug-summary">
                      <strong>{{ report.title or 'Untitled' }}</strong>
                      <span class="bug-token">status:{{ report.status }}</span>
                      <span class="bug-token">assignee:{{ report.assignee_token }}</span>
                      <span class="bug-token">priority:{{ report.priority | lower }}</span>
                      {% if report.description %}
                      <p>{{ report.description }}</p>
                      {% endif %}
                      <details>
                        <summary>Additional details</summary>
                        <p><strong>Reporter:</strong> {{ report.reporter or 'Unknown' }}</p>
                        <p><strong>Notes:</strong> {{ report.notes or '—' }}</p>
                        <p><em>File uploads are not supported for bug reports. Include any context directly in the description or notes.</em></p>
                      </details>
                    </div>
                  </td>
                  <td data-label="Status">
                    <span class="status-pill status-{{ report.status }}">{{ report.status_label }}</span>
                  </td>
                  <td data-label="Priority">{{ report.priority }}</td>
                  <td data-label="Assignee">{{ report.assignee_label }}</td>
                  <td data-label="Reporter">{{ report.reporter or '—' }}</td>
                  <td data-label="Created">{{ report.created_display }}</td>
                  <td data-label="Updated">{{ report.updated_display }}</td>
                  <td data-label="Actions">
                    <form class="bug-action-form" data-report-id="{{ report.id }}" data-update-base="{{ bug_update_base }}">
                      <label>
                        <span>Status</span>
                        <select name="status">
                          {% for option in bug_status_options %}
                          <option value="{{ option.value }}" {% if option.value == report.status %}selected{% endif %}>{{ option.label }}</option>
                          {% endfor %}
                        </select>
                      </label>
                      <label>
                        <span>Assignee</span>
                        <select name="assignee_id">
                          <option value="">Unassigned</option>
                          {% for user in bug_assignees %}
                          <option value="{{ user.id }}" {% if user.id == report.assignee_id %}selected{% endif %}>{{ user.label }}</option>
                          {% endfor %}
                        </select>
                      </label>
                      <label class="bug-notes-field">
                        <span>Notes</span>
                        <textarea name="notes" rows="2">{{ report.notes }}</textarea>
                      </label>
                      <div class="bug-action-buttons">
                        <button type="submit">Save</button>
                        <button type="button" data-action="reset">Reset</button>
                      </div>
                      <p class="bug-action-feedback" role="status" aria-live="polite"></p>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% else %}
            <p>No bug reports have been submitted yet.</p>
            {% endif %}
          </section>
        </section>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="https://cdn.jsdelivr.net/npm/simple-datatables@9.0.0/dist/umd/simple-datatables.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const sessionData = {{ chart_data | tojson }};
      const eventSummary = {{ event_summary_data | tojson }};
      const roleSummary = {{ role_breakdown_data | tojson }};

      const durationCtx = document.getElementById('sessionDurationChart');
      if (durationCtx && sessionData && sessionData.labels && sessionData.labels.length) {
        const durationMinutes = (sessionData.durations || []).map((value) => {
          const seconds = Number(value) || 0;
          return Math.round((seconds / 60) * 10) / 10;
        });
        const backtracks = sessionData.backtracking || [];

        new Chart(durationCtx, {
          type: 'bar',
          data: {
            labels: sessionData.labels,
            datasets: [
              {
                label: 'Session Duration (minutes)',
                data: durationMinutes,
                backgroundColor: '#2563eb',
                borderColor: '#1d4ed8',
                borderWidth: 1,
                yAxisID: 'y',
              },
              {
                label: 'Backtracking Events',
                data: backtracks,
                type: 'line',
                borderColor: '#e11d48',
                backgroundColor: 'rgba(225, 29, 72, 0.35)',
                fill: false,
                tension: 0.2,
                yAxisID: 'y1',
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: 'Duration (minutes)' },
              },
              y1: {
                beginAtZero: true,
                position: 'right',
                grid: { drawOnChartArea: false },
                title: { display: true, text: 'Backtracking events' },
              },
              x: {
                ticks: { autoSkip: false },
              },
            },
          },
        });
      }

      const eventCtx = document.getElementById('eventDistributionChart');
      if (eventCtx && eventSummary && eventSummary.labels && eventSummary.labels.length) {
        new Chart(eventCtx, {
          type: 'bar',
          data: {
            labels: eventSummary.labels,
            datasets: [
              {
                label: 'Event count',
                data: eventSummary.counts,
                backgroundColor: '#059669',
                borderColor: '#047857',
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            scales: {
              x: { beginAtZero: true },
            },
          },
        });
      }

      const roleCtx = document.getElementById('roleBreakdownChart');
      if (roleCtx && roleSummary && roleSummary.labels && roleSummary.labels.length) {
        const palette = ['#1d4ed8', '#6366f1', '#0f766e', '#ea580c', '#facc15', '#e11d48'];
        new Chart(roleCtx, {
          type: 'doughnut',
          data: {
            labels: roleSummary.labels,
            datasets: [
              {
                data: roleSummary.counts,
                backgroundColor: roleSummary.labels.map((_, idx) => palette[idx % palette.length]),
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' },
            },
          },
        });
      }

      let bugTableInstance = null;
      const bugTableElement = document.querySelector('#bugReportsTable');

      if (window.simpleDatatables) {
        const { DataTable } = window.simpleDatatables;
        const sessionTable = document.querySelector('#sessionTable');
        if (sessionTable) {
          new DataTable(sessionTable, {
            searchable: true,
            fixedHeight: false,
            perPage: 10,
          });
        }

        const eventTable = document.querySelector('#eventTable');
        if (eventTable) {
          new DataTable(eventTable, {
            searchable: true,
            fixedHeight: false,
            perPage: 15,
          });
        }

        if (bugTableElement) {
          bugTableInstance = new DataTable(bugTableElement, {
            searchable: true,
            fixedHeight: false,
            perPage: 10,
          });
        }
      }

      const bugFilterForm = document.querySelector('[data-bug-filters]');
      if (bugFilterForm) {
        const statusFilter = bugFilterForm.querySelector('[name="bug_status"]');
        const assigneeFilter = bugFilterForm.querySelector('[name="bug_assignee"]');
        const searchFilter = bugFilterForm.querySelector('[name="bug_search"]');

        const applyBugFilters = (event) => {
          if (event) {
            event.preventDefault();
          }

          const tokens = [];
          const statusValue = statusFilter ? statusFilter.value.trim() : '';
          const assigneeValue = assigneeFilter ? assigneeFilter.value.trim() : '';
          const searchValue = searchFilter ? searchFilter.value.trim() : '';

          if (statusValue) tokens.push(`status:${statusValue}`);
          if (assigneeValue) tokens.push(`assignee:${assigneeValue}`);
          if (searchValue) tokens.push(searchValue);

          if (bugTableInstance && bugTableInstance.input) {
            bugTableInstance.input.value = tokens.join(' ');
            bugTableInstance.input.dispatchEvent(new Event('input', { bubbles: true }));
          } else if (bugTableElement) {
            const rows = bugTableElement.querySelectorAll('tbody tr');
            rows.forEach((row) => {
              const matchesStatus = !statusValue || row.dataset.status === statusValue;
              const matchesAssignee = !assigneeValue || row.dataset.assignee === assigneeValue;
              const matchesSearch = !searchValue || row.textContent.toLowerCase().includes(searchValue.toLowerCase());
              row.style.display = matchesStatus && matchesAssignee && matchesSearch ? '' : 'none';
            });
          }
        };

        bugFilterForm.addEventListener('submit', applyBugFilters);
        if (statusFilter) statusFilter.addEventListener('change', applyBugFilters);
        if (assigneeFilter) assigneeFilter.addEventListener('change', applyBugFilters);
        if (searchFilter) searchFilter.addEventListener('input', () => applyBugFilters());

        bugFilterForm.addEventListener('reset', () => {
          window.setTimeout(() => {
            if (bugTableInstance && bugTableInstance.input) {
              bugTableInstance.input.value = '';
              bugTableInstance.input.dispatchEvent(new Event('input', { bubbles: true }));
            } else if (bugTableElement) {
              bugTableElement.querySelectorAll('tbody tr').forEach((row) => {
                row.style.display = '';
              });
            }
          }, 0);
        });
      }

      const bugActionForms = document.querySelectorAll('.bug-action-form');
      bugActionForms.forEach((form) => {
        const reportId = form.dataset.reportId;
        const updateBase = form.dataset.updateBase;
        const statusSelect = form.querySelector('[name="status"]');
        const assigneeSelect = form.querySelector('[name="assignee_id"]');
        const notesField = form.querySelector('[name="notes"]');
        const saveButton = form.querySelector('button[type="submit"]');
        const resetButton = form.querySelector('button[data-action="reset"]');
        const feedback = form.querySelector('.bug-action-feedback');

        const initialState = {
          status: statusSelect ? statusSelect.value : '',
          assignee: assigneeSelect ? assigneeSelect.value : '',
          notes: notesField ? (notesField.value || '').trim() : '',
        };

        if (resetButton) {
          resetButton.addEventListener('click', (event) => {
            event.preventDefault();
            if (statusSelect) statusSelect.value = initialState.status;
            if (assigneeSelect) assigneeSelect.value = initialState.assignee;
            if (notesField) notesField.value = initialState.notes;
            if (feedback) feedback.textContent = '';
          });
        }

        form.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (!reportId || !updateBase) return;

          const payload = {};
          if (statusSelect && statusSelect.value !== initialState.status) {
            payload.status = statusSelect.value;
          }

          if (assigneeSelect && assigneeSelect.value !== initialState.assignee) {
            payload.assignee_id = assigneeSelect.value || null;
          }

          if (notesField) {
            const noteValue = (notesField.value || '').trim();
            if (noteValue !== initialState.notes) {
              payload.notes = noteValue;
            }
          }

          if (!Object.keys(payload).length) {
            if (feedback) feedback.textContent = 'No changes to save.';
            return;
          }

          if (feedback) feedback.textContent = 'Saving...';
          if (saveButton) saveButton.disabled = true;

          try {
            const response = await fetch(`${updateBase}/${reportId}`, {
              method: 'PATCH',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
              },
              body: JSON.stringify(payload),
            });

            if (!response.ok) {
              let message = 'Failed to update bug report.';
              let parsed;
              try {
                parsed = await response.clone().json();
              } catch (error) {
                try {
                  const text = await response.text();
                  if (text) {
                    message = text;
                  }
                } catch (_) {
                  // Ignore fallback errors.
                }
                throw new Error(message);
              }

              if (parsed && typeof parsed === 'object') {
                if (parsed.description) {
                  message = parsed.description;
                } else if (parsed.error) {
                  message = parsed.error;
                } else if (parsed.detail) {
                  message = parsed.detail;
                } else {
                  try {
                    const text = await response.text();
                    if (text) {
                      message = text;
                    }
                  } catch (_) {
                    // Ignore fallback errors.
                  }
                }
              }

              throw new Error(message);
            }

            if (feedback) feedback.textContent = 'Saved.';
            window.setTimeout(() => window.location.reload(), 700);
          } catch (error) {
            if (feedback) feedback.textContent = error.message || 'Unable to save changes.';
          } finally {
            if (saveButton) saveButton.disabled = false;
          }
        });
      });
    });
  </script>
{% endblock %}
