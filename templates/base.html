<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MOAA</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  {% block extra_head %}{% endblock %}
</head>
<body class="{% if user_role == 'EMPLOYEE' %}employee-layout{% endif %}">
  {% if user_role != 'EMPLOYEE' %}
  <header class="app-header">
    <nav class="navbar" role="navigation" aria-label="Primary">
      <div class="nav-left">
        <a class="logo" href="{{ url_for('main.home') }}">
          <img src="{{ url_for('static', filename='images/company-logo.png')}}" alt="Spectra Tech Manufacturing">
        </a>
        <div class="brand-block">
          <span class="brand-title">Spectra Operations Suite</span>
          <span class="brand-subtitle">Manufacturing Oversight &amp; Analytics</span>
        </div>
      </div>
      <div class="nav-center">
        <ul class="nav-links">
          <li class="nav-item"><a href="{{ url_for('main.home') }}">Home</a></li>
          <li class="nav-item">
            <a href="#">Analysis <span class="arrow">&#9662;</span></a>
            <div class="dropdown" role="menu">
              <a href="{{ url_for('main.ppm_analysis') }}">PPM Analysis</a>
              <a href="{{ url_for('main.aoi_grades_page') }}">AOI &amp; FI Analysis</a>
              <a href="{{ url_for('main.aoi_daily_reports') }}">AOI Daily Reports</a>
              <a href="{{ url_for('main.fi_daily_reports') }}">FI Daily Reports</a>
              {% if user_role == 'ADMIN' %}
              <a href="{{ url_for('main.analysis_tracker_logs') }}">Application Tracker Logs</a>
              {% endif %}
            </div>
          </li>
          <li class="nav-item">
            <a href="#">Tools <span class="arrow">&#9662;</span></a>
            <div class="dropdown" role="menu">
              <a href="#">Rework Stencil Lookup</a>
              <a href="#">Verified Part Markings</a>
              <a href="{{ url_for('main.assembly_forecast') }}">Assembly Forecast</a>
            </div>
          </li>
          <li class="nav-item">
            <a href="#">Production <span class="arrow">&#9662;</span></a>
            <div class="dropdown" role="menu">
              <a href="#"><em>Jobs</em></a>
              <a href="#"><em>SPC Dashboard</em></a>
            </div>
          </li>
          <li class="nav-item">
            <a href="#">Reports <span class="arrow">&#9662;</span></a>
            <div class="dropdown" role="menu">
              <a href="{{ url_for('main.integrated_report') }}">AOI Integrated Report</a>
              <a href="{{ url_for('main.operator_report') }}">Operator Report</a>
              <a href="{{ url_for('main.aoi_daily_report_page') }}">AOI Daily Report</a>
            </div>
          </li>
        </ul>
      </div>
      <div class="nav-right">
        {% if username %}
        <span class="user-text">Signed in as {{ username }}</span>
        {% endif %}
        <a class="nav-utility" href="#">Docs</a>
        {% if user_role == 'ADMIN' %}
        <a class="nav-utility" href="{{ url_for('main.admin_panel') }}">Admin Console</a>
        {% endif %}
        <a class="nav-utility" href="{{ url_for('auth.logout') }}" data-track-session-end="true">Logout</a>
      </div>
    </nav>
  </header>
  {% endif %}
  <main class="content" role="main">
    {% block content %}{% endblock %}
  </main>

  <div
    id="bug-chat-container"
    class="bug-chat-container"
    data-endpoint="{{ url_for('main.submit_bug_report') }}"
    data-signed-in="{{ 'true' if user_id else 'false' }}"
    data-username="{{ username or '' }}"
  >
    <button
      type="button"
      class="bug-chat-trigger"
      aria-haspopup="dialog"
      aria-controls="bug-chat-panel"
      aria-expanded="false"
    >
      <span class="trigger-label">Report an issue</span>
      <span class="trigger-icon" aria-hidden="true">&#9993;</span>
    </button>

    <section
      id="bug-chat-panel"
      class="bug-chat-panel"
      role="dialog"
      aria-modal="false"
      aria-labelledby="bug-chat-title"
      tabindex="-1"
      hidden
    >
      <header class="bug-chat-header">
        <div class="header-text">
          <h2 id="bug-chat-title">Need help or found a bug?</h2>
          <p class="header-subtitle">Send a quick note to the support team.</p>
        </div>
        <button type="button" class="bug-chat-close" aria-label="Close support chat">&times;</button>
      </header>

      <div class="bug-chat-body">
        <div class="bug-chat-messages" aria-live="polite" aria-atomic="false"></div>

        <form class="bug-chat-form" novalidate>
          <fieldset class="bug-chat-auth-guard" hidden>
            <legend>Sign in required</legend>
            <p class="auth-message">Please <a href="{{ url_for('auth.login') }}">sign in</a> to report an issue.</p>
          </fieldset>

          <fieldset class="bug-chat-fields">
            <legend class="sr-only">Bug details</legend>
            <label class="bug-chat-field">
              <span>Title</span>
              <input type="text" name="title" required maxlength="200" autocomplete="off" />
            </label>
            <label class="bug-chat-field">
              <span>Description</span>
              <textarea name="description" rows="4" required></textarea>
            </label>
            <div class="bug-chat-row">
              <label class="bug-chat-field">
                <span>Priority</span>
                <select name="priority">
                  <option value="">Select</option>
                  <option value="low">Low</option>
                  <option value="medium">Medium</option>
                  <option value="high">High</option>
                </select>
              </label>
              <label class="bug-chat-field">
                <span>Severity</span>
                <select name="severity">
                  <option value="">Select</option>
                  <option value="minor">Minor</option>
                  <option value="major">Major</option>
                  <option value="critical">Critical</option>
                </select>
              </label>
            </div>
            <label class="bug-chat-field">
              <span>Environment</span>
              <input type="text" name="environment" placeholder="e.g. Production, Chrome 124" />
            </label>
            <label class="bug-chat-field">
              <span>Attachments (optional)</span>
              <input type="file" name="attachments" multiple />
            </label>
          </fieldset>

          <div class="bug-chat-actions">
            <button type="submit" class="bug-chat-submit">Send report</button>
            <button type="button" class="bug-chat-reset" hidden>Report another issue</button>
          </div>
        </form>
      </div>
    </section>
  </div>
  {% set tracking_context = {
    'user': {
      'id': user_id,
      'name': username,
      'role': user_role,
    },
    'tracking': {
      'sessionId': tracking_session_id,
      'clickUrl': url_for('main.tracking_click_event'),
      'sessionStartUrl': url_for('main.tracking_session_start'),
      'sessionEndUrl': url_for('main.tracking_session_end'),
    }
  } %}
  <script>
    window.APP_CONTEXT = {{ tracking_context | tojson }};
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  {% block scripts %}{% endblock %}
</body>
</html>
