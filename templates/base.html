<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Op Suite</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  {% block extra_head %}{% endblock %}
</head>
{% set employee_preview_active = employee_preview_active|default(false) %}
{% set employee_preview_return_url = employee_preview_return_url|default(request.args.get('return') or request.url) %}
<body class="{% if user_role == 'EMPLOYEE' or employee_preview_active %}employee-layout{% endif %}">
  {% macro feature_nav_link(label, href, slug) -%}
    {% set feature = (feature_states.get(slug) if feature_states else {}) %}
    {% set status = feature.get('status', 'available') %}
    {% set globally_locked = status != 'available' %}
    {% set locked_for_user = globally_locked and user_role != 'ADMIN' %}
    {% set message = feature.get('message') or feature.get('description') or '' %}
    <a
      href="{{ href }}"
      class="{% if locked_for_user %}is-locked{% endif %}"
      data-feature-slug="{{ slug }}"
      data-feature-status="{{ status }}"
      data-feature-label="{{ feature.get('label', label) }}"
      data-feature-message="{{ message }}"
      {% if locked_for_user %}data-feature-lock="true" aria-disabled="true"{% endif %}
    >
      {{ label }}
      {% if globally_locked %}
      <span class="nav-lock-indicator" aria-hidden="true">Locked</span>
      {% endif %}
    </a>
  {%- endmacro %}
  {% if user_role != 'EMPLOYEE' and not employee_preview_active %}
  <header class="app-header">
    <nav class="navbar" role="navigation" aria-label="Primary">
      <div class="nav-left">
        <a class="logo" href="{{ url_for('main.home') }}">
          <img src="{{ url_for('static', filename='images/company-logo.png')}}" alt="Spectra Tech Manufacturing">
        </a>
        <div class="brand-block">
          <span class="brand-title">Spectra Operations Suite</span>
          <span class="brand-subtitle">Manufacturing Oversight &amp; Analytics</span>
        </div>
      </div>
      <div class="nav-center">
        <ul class="nav-links">
          <li class="nav-item"><a href="{{ url_for('main.home') }}">Home</a></li>
          <li class="nav-item">
            <a href="#">Analysis <span class="arrow">&#9662;</span></a>
            <div class="dropdown" role="menu">
              {{ feature_nav_link('PPM Analysis', url_for('main.ppm_analysis'), 'analysis_ppm') }}
              {{ feature_nav_link('DPM Analysis', url_for('main.dpm_analysis'), 'analysis_dpm') }}
              {{ feature_nav_link('AOI & FI Analysis', url_for('main.aoi_grades_page'), 'analysis_aoi_grades') }}
              {{ feature_nav_link('AOI Daily Reports', url_for('main.aoi_daily_reports'), 'analysis_aoi_daily') }}
              {{ feature_nav_link('FI Daily Reports', url_for('main.fi_daily_reports'), 'analysis_fi_daily') }}
              {% if user_role == 'ADMIN' %}
              <a href="{{ url_for('main.analysis_tracker_logs') }}">Application Tracker Logs</a>
              {% endif %}
            </div>
          </li>
          <li class="nav-item">
            <a href="#">Tools <span class="arrow">&#9662;</span></a>
            <div class="dropdown" role="menu">
              <a href="#">Rework Stencil Lookup</a>
              <a href="#">Verified Part Markings</a>
              {{ feature_nav_link('Assembly Forecast', url_for('main.assembly_forecast'), 'tools_assembly_forecast') }}
            </div>
          </li>
          <li class="nav-item">
            <a href="#">Production <span class="arrow">&#9662;</span></a>
            <div class="dropdown" role="menu">
              <a href="#"><em>Jobs</em></a>
              <a href="#"><em>SPC Dashboard</em></a>
            </div>
          </li>
          <li class="nav-item">
            <a href="#">Reports <span class="arrow">&#9662;</span></a>
            <div class="dropdown" role="menu">
              {{ feature_nav_link('AOI Integrated Report', url_for('main.integrated_report'), 'reports_integrated') }}
              {{ feature_nav_link('Operator Report', url_for('main.operator_report'), 'reports_operator') }}
              {{ feature_nav_link('AOI Daily Report', url_for('main.aoi_daily_report_page'), 'reports_aoi_daily') }}
            </div>
          </li>
        </ul>
      </div>
      <div class="nav-right">
        {% if username %}
        <span class="user-text">Signed in as {{ username }}</span>
        {% endif %}
        <a class="nav-utility" href="#">Docs</a>
        {% if user_role == 'ADMIN' %}
        <a class="nav-utility" href="{{ url_for('main.admin_panel') }}">Admin Console</a>
        {% endif %}
        <a class="nav-utility" href="{{ url_for('auth.logout') }}" data-track-session-end="true">Logout</a>
      </div>
    </nav>
  </header>
  {% endif %}
  <main class="content" role="main">
    {% block content %}{% endblock %}
  </main>

  <div class="modal-overlay" data-feature-lock-modal hidden tabindex="-1">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="feature-lock-title">
      <div class="modal-header">
        <h2 id="feature-lock-title">Feature temporarily unavailable</h2>
        <button type="button" class="modal-close" data-feature-lock-close aria-label="Close">Close</button>
      </div>
      <div class="modal-body">
        <p data-feature-lock-message></p>
      </div>
    </div>
  </div>

  <div
    id="bug-chat-container"
    class="bug-chat-container{% if user_role == 'ADMIN' %} has-preview-toggle{% endif %}"
    data-endpoint="{{ url_for('main.submit_bug_report') }}"
    data-signed-in="{{ 'true' if user_id else 'false' }}"
    data-username="{{ username or '' }}"
    data-user-role="{{ user_role or '' }}"
  >
    <button
      type="button"
      class="bug-chat-trigger"
      aria-haspopup="dialog"
      aria-controls="bug-chat-panel"
      aria-expanded="false"
    >
      <span class="trigger-label">Report an issue</span>
      <span class="trigger-icon" aria-hidden="true">&#9993;</span>
    </button>
    {% if user_role == 'ADMIN' %}
    <div class="bug-chat-preview-control">
      <label class="employee-preview-toggle">
        <input
          type="checkbox"
          data-admin-employee-toggle
          data-admin-url="{{ employee_preview_return_url }}"
          data-employee-url="{{ url_for('main.admin_employee_portal', return=request.path) }}"
          data-preview-active="{{ 'true' if employee_preview_active else 'false' }}"
          {% if employee_preview_active %}checked{% endif %}
        />
        <span class="employee-preview-track" aria-hidden="true">
          <span class="employee-preview-thumb"></span>
        </span>
        <span class="employee-preview-text" data-preview-toggle-label>
          Employee portal preview
        </span>
      </label>
    </div>
    {% endif %}

    <section
      id="bug-chat-panel"
      class="bug-chat-panel"
      role="dialog"
      aria-modal="false"
      aria-labelledby="bug-chat-title"
      tabindex="-1"
      hidden
    >
      <header class="bug-chat-header">
        <div class="header-text">
          <h2 id="bug-chat-title">Need help or found a bug?</h2>
          <p class="header-subtitle">Send a quick note to the support team.</p>
        </div>
        <button type="button" class="bug-chat-close" aria-label="Close support chat">&times;</button>
      </header>

      <div class="bug-chat-body">
        <div class="bug-chat-messages" aria-live="polite" aria-atomic="false"></div>

        <form class="bug-chat-form" novalidate>
          <fieldset class="bug-chat-auth-guard" hidden>
            <legend>Sign in required</legend>
            <p class="auth-message">Please <a href="{{ url_for('auth.login') }}">sign in</a> to report an issue.</p>
          </fieldset>

          <fieldset class="bug-chat-fields">
            <legend class="sr-only">Bug details</legend>
            <label class="bug-chat-field">
              <span>Title</span>
              <input type="text" name="title" required maxlength="200" autocomplete="off" />
            </label>
            <label class="bug-chat-field">
              <span>Description</span>
              <textarea name="description" rows="4" required></textarea>
            </label>
            <div class="bug-chat-row">
              <label class="bug-chat-field">
                <span>Priority</span>
                <select name="priority">
                  <option value="">Select</option>
                  <option value="low">Low</option>
                  <option value="medium">Medium</option>
                  <option value="high">High</option>
                </select>
              </label>
              <label class="bug-chat-field">
                <span>Severity</span>
                <select name="severity">
                  <option value="">Select</option>
                  <option value="minor">Minor</option>
                  <option value="major">Major</option>
                  <option value="critical">Critical</option>
                </select>
              </label>
            </div>
          </fieldset>

          <div class="bug-chat-actions">
            <button type="submit" class="bug-chat-submit">Send report</button>
            <button type="button" class="bug-chat-reset" hidden>Report another issue</button>
          </div>
        </form>
      </div>
    </section>
  </div>
  {% set tracking_context = {
    'user': {
      'id': user_id,
      'name': username,
      'role': user_role,
    },
    'tracking': {
      'sessionId': tracking_session_id,
      'clickUrl': url_for('main.tracking_click_event'),
      'sessionStartUrl': url_for('main.tracking_session_start'),
      'sessionEndUrl': url_for('main.tracking_session_end'),
    }
  } %}
  <script>
    window.APP_CONTEXT = {{ tracking_context | tojson }};
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  {% block scripts %}{% endblock %}
</body>
</html>
