{% macro format_pct(value) -%}{{ '%.2f'|format(value) ~ '%' if value is not none else '--' }}{%- endmacro %}

{% macro format_ratio(value) -%}{{ '%.2f'|format(value) if value is not none else '--' }}{%- endmacro %}

<section class="report-section">
  <h2>Executive Summary</h2>
  {% set summary = linePeriodSummary or {} %}
  {% set focus = summary.get('focus') %}
  {% set overall = summary.get('overall') %}
  {% set best = summary.get('best') %}
  {% set worst = summary.get('worst') %}
  <div class="summary-lede">
    {% if focus %}
      {% set has_range = start or end %}
      {% set start_label = start or 'the start of the selected period' %}
      {% set end_label = end or 'the end of the selected period' %}
      {% set boards = focus.total_boards|round(0)|int %}
      {% set true_yield = focus.true_part_yield_pct %}
      {% set window_yield = focus.window_yield_pct %}
      <p>{% if has_range %}Between {{ start_label }} and {{ end_label }},{% else %}Across the selected period,{% endif %} {{ focus.line }} inspected {{ boards }} boards with a true part yield of {{ format_pct(true_yield) }}{% if window_yield is not none %} and a window yield of {{ format_pct(window_yield) }}{% endif %}.</p>
    {% else %}
      <p>No line data is available for the selected period.</p>
    {% endif %}
    {% if overall %}
      <p>Average false calls per board: {{ format_ratio(overall.fc_per_board) }}; defects per board: {{ format_ratio(overall.defects_per_board) }}.</p>
    {% endif %}
    {% if best or worst %}
      {% if best %}
        {% set best_yield = best.true_part_yield_pct if best.true_part_yield_pct is not none else (best.window_yield_pct if best.window_yield_pct is not none else best.raw_part_yield_pct) %}
      {% endif %}
      {% if worst %}
        {% set worst_yield = worst.true_part_yield_pct if worst.true_part_yield_pct is not none else (worst.window_yield_pct if worst.window_yield_pct is not none else worst.raw_part_yield_pct) %}
      {% endif %}
      <p>{% if best %}<strong>Best yield:</strong> {{ best.line }} at {{ format_pct(best_yield) }}{% if worst %} {% else %}.{% endif %}{% endif %}{% if worst %}<strong>Needs attention:</strong> {{ worst.line }} at {{ format_pct(worst_yield) }}.{% endif %}</p>
    {% endif %}
  </div>
  <div class="kpi-grid">
    <article class="section-card">
      <h3>Top Lines</h3>
      <ul>
        {% if benchmarking.bestYield %}
        {% set best = benchmarking.bestYield %}
        {% if best.windowYield is not none %}
        {% set best_label = 'Window Yield' %}
        {% set best_value = best.windowYield %}
        {% elif best.truePartYield is not none %}
        {% set best_label = 'True Part Yield' %}
        {% set best_value = best.truePartYield %}
        {% elif best.rawPartYield is not none %}
        {% set best_label = 'Raw Part Yield' %}
        {% set best_value = best.rawPartYield %}
        {% else %}
        {% set best_label = 'Yield' %}
        {% set best_value = 0 %}
        {% endif %}
        <li><strong>Best {{ best_label }}:</strong> {{ best.line }} ({{ best_value|round(2) }}%)</li>
        {% endif %}
        {% if benchmarking.lowestFalseCalls %}
        <li><strong>Lowest False Calls:</strong> {{ benchmarking.lowestFalseCalls.line }} ({{ benchmarking.lowestFalseCalls.falseCallsPerBoard|round(2) }})</li>
        {% endif %}
        {% if benchmarking.mostConsistent %}
        <li><strong>Most Consistent:</strong> {{ benchmarking.mostConsistent.line }} (σ {{ benchmarking.mostConsistent.stddev|round(2) }})</li>
        {% endif %}
      </ul>
    </article>
    <article class="section-card">
      <h3>Company Averages</h3>
      <ul>
        <li>Window Yield: {{ (companyAverages.windowYield if companyAverages.windowYield is not none else 0)|round(2) }}%</li>
        <li>True Part Yield: {{ (companyAverages.truePartYield if companyAverages.truePartYield is not none else 0)|round(2) }}%</li>
        <li>Raw Part Yield: {{ (companyAverages.rawPartYield if companyAverages.rawPartYield is not none else 0)|round(2) }}%</li>
        <li>False Calls / Board: {{ companyAverages.falseCallsPerBoard|round(2) }}</li>
        <li>False Call PPM: {{ (companyAverages.falseCallPpm if companyAverages.falseCallPpm is not none else 0)|round(2) }}</li>
        <li>False Call DPM: {{ (companyAverages.falseCallDpm if companyAverages.falseCallDpm is not none else 0)|round(2) }}</li>
        <li>Defect DPM: {{ (companyAverages.defectDpm if companyAverages.defectDpm is not none else 0)|round(2) }}</li>
        <li>NG Parts: {{ companyAverages.ngParts|round(0) }}</li>
        <li>NG Windows: {{ companyAverages.ngWindows|round(0) }}</li>
        <li>Windows / Board: {{ (companyAverages.windowsPerBoard if companyAverages.windowsPerBoard is not none else 0)|round(2) }}</li>
        <li>Defects / Board: {{ (companyAverages.defectsPerBoard if companyAverages.defectsPerBoard is not none else 0)|round(2) }}</li>
      </ul>
    </article>
    <article class="section-card">
      <h3>Key Insights</h3>
      <ul>
        {% set drift = (trendInsights.lineDrift or [])[:3] %}
        {% if drift %}
          {% for item in drift %}
          <li>{{ item.line }} window yield drifted {{ item.change|round(2) }} pts ({{ item.start|round(2) }}% → {{ item.end|round(2) }}%).</li>
          {% endfor %}
        {% else %}
          <li>No significant yield drift detected across lines.</li>
        {% endif %}
      </ul>
    </article>
  </div>
</section>
