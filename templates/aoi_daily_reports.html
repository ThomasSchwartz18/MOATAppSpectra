{% extends 'base.html' %}

{% block content %}
<h2>AOI Daily Reports</h2>

  <div class="analysis-grid">
    <!-- Left: Builder / Upload Tabs -->
    <div class="analysis-left section-card">
      <div class="tab-bar">
        <div class="tab active" data-target="builder-tab">Chart Builder</div>
        {% if username == 'ADMIN' %}
        <div class="tab" data-target="upload-tab">Upload</div>
        {% endif %}
      </div>

      <div id="builder-tab" class="tab-content" style="display:block;">
        <div class="field-row">
          <div class="field">
            <label for="chart-title">Chart Title</label>
            <input id="chart-title" placeholder="Chart title" />
          </div>
          <div class="field">
            <label for="chart-description">Chart Description</label>
            <textarea id="chart-description" placeholder="Describe this chart"></textarea>
          </div>
        </div>

        <div class="section-title" style="margin-top:10px;">Data Range</div>
        <div class="field-row">
          <div class="field">
            <label for="start-date">Start Date</label>
            <input type="date" id="start-date" />
          </div>
          <div class="field">
            <label for="end-date">End Date</label>
            <input type="date" id="end-date" />
          </div>
        </div>

        <div class="section-title" style="margin-top:10px;">Filters</div>
        <div class="field-row">
          <div class="field">
            <label for="filter-job">Job Number</label>
            <input id="filter-job" placeholder="e.g. 12345,67890" />
          </div>
          <div class="field">
            <label for="filter-rev">Revision</label>
            <input id="filter-rev" placeholder="e.g. A,B" />
          </div>
        </div>
        <div class="field-row">
          <div class="field">
            <label for="filter-assembly">Assembly Number</label>
            <input id="filter-assembly" placeholder="e.g. ASM1,ASM2" />
          </div>
          <div class="field">
            <label>Customer</label>
            <div id="customer-wrapper"></div>
          </div>
        </div>
        <div class="field-row">
          <div class="field">
            <label>Operator</label>
            <div id="operator-wrapper"></div>
          </div>
        </div>

        <div class="field-row" style="margin-top:12px;">
          <div class="field" style="flex:1;">
            <label for="save-name">Save As</label>
            <input id="save-name" placeholder="Chart name" />
          </div>
          <button type="button" id="save-chart">Save</button>
          <button type="button" id="run-chart">Run</button>
        </div>
      </div>

      {% if username == 'ADMIN' %}
      <div id="upload-tab" class="tab-content" style="display:none;">
        <form id="upload-form">
          <div class="field-row">
            <div class="field" style="flex:1;">
              <label for="upload-csv">CSV File</label>
              <input type="file" id="upload-csv" accept=".csv" />
            </div>
          </div>
          <button type="submit" id="upload-button">Upload</button>
        </form>
      </div>
      {% endif %}
    </div>

    <!-- Top Right: Saved Queries + Search -->
    <div class="analysis-top-right section-card">
      <div class="section-title">Saved Charts</div>
      <div class="field-row" style="margin-bottom:8px;">
        <div class="field" style="flex:1;">
          <label for="saved-search">Search</label>
          <input id="saved-search" placeholder="Filter saved charts" />
        </div>
      </div>
      <ul id="saved-list" style="margin:0;padding-left:16px;"></ul>
      <small>Select a preset to load its metric.</small>
    </div>

    <!-- Bottom Right: Results -->
    <div class="analysis-bottom-right section-card">
      <div class="section-title">Results: <span id="result-chart-name"></span></div>
      <div class="field-row" style="margin-bottom:6px;">
        <button type="button" id="expand-chart">Expand</button>
        <button type="button" id="download-pdf">Download PDF</button>
        <span class="spinner" id="download-spinner" hidden></span>
        <button type="button" id="copy-image">Copy Image</button>
      </div>
      <div class="preview-card" style="height: 300px; overflow:auto;">
        <canvas id="aoiChart"></canvas>
        <table id="preview-table" class="data-table" style="display:none;"></table>
      </div>
      <div id="chart-description-result" class="preview-info" style="margin-top:4px;"></div>
      <div id="aoi-info" class="preview-info" style="margin-top:4px;"></div>
    </div>
  </div>

<!-- Modal for Expanded View + Data Table -->
<div id="chart-modal" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <div id="modal-title">Chart Detail</div>
      <button id="modal-close" class="modal-close">Close</button>
    </div>
    <div class="modal-chart-box">
      <canvas id="aoiChartExpanded"></canvas>
    </div>
    <div class="field-row" style="margin-top:10px;">
      <button type="button" id="modal-download-chart">Download Chart</button>
      <button type="button" id="modal-download-csv">Download CSV</button>
      </div>
    <div style="margin-top:10px;" class="section-title">Data</div>
    <table id="modal-data-table" class="data-table">
      <thead><tr><th id="data-label-header">Operator</th><th>Accepted</th><th>Rejected</th><th>Accepted %</th><th>Rejected %</th></tr></thead>
      <tbody id="data-tbody"></tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>
<script type="module" src="{{ url_for('static', filename='js/aoi.js') }}"></script>
{% endblock %}
